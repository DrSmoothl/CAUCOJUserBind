# CAUCOJ 用户绑定插件

# HydroOJ 用户绑定插件

这是一个用于HydroOJ的用户绑定插件，允许管理员导入学生信息，学生通过统一的绑定界面将账号与学生身份关联。

## 功能特性

- **学生信息管理**：管理员可以批量导入学生信息（学号、姓名）
- **用户管理**：管理员可以设置哪些用户是本校学生，只有本校学生才需要进行身份绑定
- **统一绑定界面**：学生访问统一的绑定页面，输入学号和姓名进行匹配绑定
- **自动绑定检查**：被设置为本校学生的用户登录时将被强制要求进行身份绑定
- **数据库扩展**：自动扩展用户表，添加学号、姓名、学生状态等字段
- **权限控制**：只有具备管理权限的用户才能访问管理界面

## 安装方法

1. 将插件文件复制到HydroOJ的插件目录
2. 运行安装脚本（Windows用户双击 `install.bat`）
3. 重启HydroOJ服务

## 使用流程

### 管理员操作

1. **设置本校学生**
   - 访问 `/user-bind/user-manage` 页面
   - 搜索并找到需要设置的用户
   - 点击"设为本校学生"按钮将用户标记为本校学生
   - 只有被标记为本校学生的用户才需要进行身份绑定

2. **导入学生信息**
   - 访问 `/user-bind/import` 页面
   - 按格式输入学生信息：每行一个，格式为 `学号 姓名`
   - 点击"导入学生"按钮

3. **管理学生记录**
   - 访问 `/user-bind/manage` 页面
   - 查看所有学生记录和绑定状态
   - 删除未使用的学生记录

### 学生操作

1. **账号绑定**
   - 访问 `/user-bind` 页面
   - 输入学号和姓名
   - 系统自动匹配已导入的学生记录进行绑定
   - 绑定成功后显示确认页面

2. **自动检查**
   - 被设置为本校学生的用户首次登录时，系统会自动检查绑定状态
   - 未绑定的本校学生会被重定向到绑定页面，必须完成绑定才能继续使用系统

## 数据结构

### 学生记录集合 (student_records)
```javascript
{
  _id: ObjectId,
  studentId: String,      // 学号
  studentName: String,    // 姓名
  used: Boolean,          // 是否已绑定
  usedBy: ObjectId,       // 绑定的用户ID（如果已绑定）
  usedTime: Date,         // 绑定时间（如果已绑定）
  createTime: Date        // 创建时间
}
```

### 用户表扩展字段
```javascript
{
  studentId: String,      // 学号
  studentName: String,    // 姓名
  isStudent: Boolean      // 是否为学校学生
}
```

## 权限要求

- **管理界面访问**：需要 `PRIV.PRIV_EDIT_SYSTEM` 权限
- **用户绑定**：所有注册用户都可以进行绑定操作

## 技术实现

- **框架**：基于HydroOJ 5.0+ 插件系统
- **数据库**：MongoDB
- **模板引擎**：Nunjucks
- **前端**：使用HydroOJ默认样式和组件

## Hook机制

插件使用HydroOJ的Hook系统实现以下功能：

- `handler/before-prepare`：为所有handler添加用户绑定信息
- `handler/after/UserLogin#post`：登录后检查绑定状态

## 许可证

本插件采用 AGPL-3.0 许可证。

## 功能特性

### 1. 用户表扩展
- **学号字段** (`studentId`): 数字类型，存储学生学号
- **姓名字段** (`studentName`): 字符串类型，存储真实姓名  
- **本校学生标识** (`isSchoolStudent`): 布尔类型，标识是否为本校学生

### 2. 邀请链接绑定机制
- 管理员可以批量导入学号和姓名信息
- 系统自动生成唯一的绑定链接
- 用户通过链接进行一次性绑定
- 绑定后无法解绑或修改

### 3. 强制绑定检查
- 本校学生登录时自动检查绑定状态
- 未绑定的本校学生将被强制进入绑定界面
- 完成绑定后才能正常使用系统

## 安装方法

1. 将插件文件复制到 Hydro 插件目录
2. 添加插件：
   ```bash
   hydrooj addon add /path/to/CAUCOJUserBind
   ```
3. 重启 Hydro 服务：
   ```bash
   pm2 restart hydrooj
   ```

## 使用指南

### 管理员操作

#### 1. 访问管理界面
- 绑定管理：`/user-bind/manage`
- 批量导入：`/user-bind/import`

#### 2. 批量导入学生信息
1. 访问 `/user-bind/import`
2. 在文本框中输入学生信息，格式为：
   ```
   202301001 张三
   202301002 李四
   202301003 王五明
   ```
3. 点击"生成邀请链接"
4. 复制生成的绑定链接发给对应学生

#### 3. 管理邀请链接
- 查看所有邀请链接的使用状态
- 删除未使用的邀请链接
- 查看绑定记录和用户信息

### 学生操作

#### 1. 通过邀请链接绑定
1. 点击管理员提供的绑定链接
2. 登录系统（如未登录）
3. 确认待绑定的学号和姓名信息
4. 点击"确认绑定"完成绑定

#### 2. 强制绑定流程
1. 本校学生首次登录系统
2. 系统检测到未绑定学号信息
3. 自动跳转到绑定提醒页面
4. 联系管理员获取绑定链接
5. 完成绑定后可正常使用系统

## 权限控制

- **普通用户**: 可以通过邀请链接进行绑定
- **域管理员** (`PRIV_CREATE_DOMAIN`): 可以管理所有绑定功能
  - 批量导入学生信息
  - 查看和管理邀请链接
  - 删除未使用的邀请链接

## 路由说明

| 路由 | 功能 | 权限要求 |
|------|------|----------|
| `/user-bind/manage` | 绑定管理界面 | 域管理员 |
| `/user-bind/import` | 批量导入界面 | 域管理员 |
| `/user-bind/:code` | 用户绑定界面 | 无 |
| `/user-bind/check` | 绑定检查页面 | 登录用户 |
| `/user-bind/delete/:code` | 删除邀请链接 | 域管理员 |

## 数据库结构

### 用户表扩展字段
```typescript
interface UserDocument {
    studentId?: string;      // 学号
    studentName?: string;    // 姓名
    isSchoolStudent?: boolean; // 是否为本校学生
}
```

### 邀请链接表
```typescript
interface UserBindInvite {
    _id: string;           // 邀请码
    studentId: string;     // 学号
    studentName: string;   // 姓名
    createTime: Date;      // 创建时间
    used: boolean;         // 是否已使用
    usedBy?: number;       // 使用者用户ID
    usedTime?: Date;       // 使用时间
}
```

## 安全特性

1. **唯一性保证**: 每个邀请链接只能使用一次
2. **重复绑定防护**: 已绑定用户无法重复绑定
3. **权限控制**: 管理功能仅限域管理员访问
4. **数据不可变**: 绑定完成后无法修改或解绑
5. **路径白名单**: 绑定检查时排除特定路径避免循环重定向

## 注意事项

1. 学号和姓名一旦绑定无法修改，请确保信息准确
2. 邀请链接具有唯一性，请勿重复生成相同学号的链接
3. 本校学生标识需要管理员手动设置或通过其他方式自动标识
4. 建议定期清理未使用的过期邀请链接

## 技术细节

- 基于 HydroOJ 5.0.0-beta.5 开发
- 使用 MongoDB 作为数据存储
- 采用 TypeScript 编写，提供完整类型支持
- 模板使用 Nunjucks 引擎
- 支持国际化（中文）
- **使用 Hook 机制实现功能扩展**：
  - `handler/before-prepare`: 全局检查本校学生绑定状态
  - `handler/after/UserLogin#post`: 登录后检查绑定状态
  - `handler/after/UserDetail#get`: 用户详情页显示绑定信息
  - `handler/after/ContestScoreboard#get`: 比赛排行榜显示真实姓名

## Hook 机制优势

相比传统的中间件方式，使用 HydroOJ 的 Hook 机制有以下优势：

1. **事件驱动**：在特定的处理阶段插入自定义逻辑
2. **性能更好**：只在需要时执行，不影响其他路由
3. **更灵活**：可以精确控制在哪个阶段执行
4. **易于维护**：符合 HydroOJ 的插件开发最佳实践
