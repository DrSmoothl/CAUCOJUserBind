# CAUCOJUserBind 重构说明

## 重构概述

本次重构将原有的简单用户绑定系统重新设计为基于学校组和用户组的分层权限管理系统。

## 新架构特点

### 1. 数据模型

#### 学校组 (school_groups)
```javascript
{
    "_id": "MongoDB ObjectId",
    "name": "学校名称",
    "createdAt": "创建时间(ISODate)",
    "createdBy": "创建用户（UID）",
    "extraInfo": [] // 其他元信息（便于日后扩展）
}
```

#### 用户组 (user_groups)
```javascript
{
    "_id": "MongoDB ObjectId",
    "name": "用户组名",
    "createdAt": "创建时间(ISODate)",
    "createdBy": "创建用户（UID）",
    "parentSchoolId": "所属学校组ID",
    "students": [
        {
            "studentId": "学号",
            "realName": "真实姓名",
            "bound": false, // 是否已绑定
            "boundBy": "绑定用户ID",
            "boundAt": "绑定时间"
        }
    ]
}
```

#### 绑定令牌 (bind_tokens)
```javascript
{
    "_id": "绑定令牌（哈希值）",
    "type": "user_group | school_group",
    "targetId": "用户组或学校组的ID",
    "createdAt": "创建时间",
    "createdBy": "创建用户ID",
    "expiresAt": "过期时间（可选）"
}
```

#### 用户表扩展
```javascript
{
    "realName": "真实姓名",
    "studentId": "学号",
    "parentUserGroupId": [], // 所属用户组的_id数组
    "parentSchoolId": [], // 所属学校组的_id数组
}
```

### 2. 绑定流程

#### 用户绑定流程
1. **新用户绑定**：
   - 用户 → 访问老师创建的用户组绑定链接 → 填写学号姓名 → 绑定成功 → 继承用户组权限 → 继承学校组权限

2. **已有学校组用户绑定**：
   - 用户（已有学校组） → 访问用户组绑定链接 → 判断所属学校组是否一致
   - 如果一致：不需要重新绑定，直接加入用户组
   - 如果不一致：提示冲突，无法绑定

#### 老师创建用户组流程
1. 老师访问创建用户组界面
2. 选择所属学校组
3. 输入用户组名称和学生信息（学号、姓名）
4. 系统生成绑定链接（如：`/bind/6fc99f543afa2d5b86bd05caa04f6c8d7b4bcc1376f87d956e79650c33cd44ca`）
5. 分发链接给学生等待绑定

#### 系统管理员创建学校组流程
1. 系统管理员访问创建学校组界面
2. 输入学校基本信息
3. 系统检查是否重复
4. 生成学校组和对应的绑定链接

### 3. 路由设计

```
/school-group/manage     - 学校组管理（系统管理员）
/school-group/create     - 创建学校组（系统管理员）
/user-group/manage       - 用户组管理（系统管理员）
/user-group/create       - 创建用户组（老师/管理员）
/bind/:token            - 绑定界面（通用绑定入口）
```

### 4. 权限控制

- **学校组权限**：用户必须属于学校组才能访问训练、作业、比赛等功能
- **用户组权限**：可以进一步细化权限控制（预留扩展）
- **管理员权限**：系统管理员可以创建学校组和用户组
- **超级管理员豁免**：root用户（uid=2）可以访问所有功能

### 5. 显示优化

- 管理员查看排行榜时显示格式：`学号 真实姓名(用户名)`
- 用户详情页显示绑定信息和所属组织
- 自动检测权限和绑定状态

## 使用示例

### 1. 创建学校组
```
管理员 → /school-group/create → 输入"清华大学" → 获得绑定链接
```

### 2. 创建用户组
```
老师 → /user-group/create → 选择"清华大学" → 输入"2024级计算机1班" → 导入学生名单 → 获得绑定链接
```

### 3. 学生绑定
```
学生 → 访问绑定链接 → 填写学号姓名 → 绑定成功 → 获得相应权限
```

## 技术特点

1. **灵活的权限体系**：支持多层级权限管理
2. **安全的绑定机制**：使用令牌系统确保绑定安全
3. **完善的冲突处理**：智能处理学校组冲突
4. **扩展性强**：预留扩展接口，便于未来功能增强
5. **向后兼容**：保留原有的显示名称处理逻辑

## 迁移注意事项

1. 需要创建新的数据库集合
2. 需要相应的模板文件支持
3. 建议先在测试环境部署验证
4. 可以编写迁移脚本将旧数据转换为新格式
