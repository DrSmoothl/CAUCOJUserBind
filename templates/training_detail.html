{% extends "layout/basic.html" %}
{% block content %}
<style>
/* ËÆ≠ÁªÉËØ¶ÊÉÖÈ°µÈù¢‰∏ìÁî®Ê†∑Âºè - ÁÆÄÊ¥ÅËÆæËÆ° */
.training-page {
  max-width: 1400px;
  margin: 0 auto;
  padding: 20px;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
}

/* ‰∏ªË¶ÅÂ∏ÉÂ±ÄÂÆπÂô® */
.training-layout {
  display: flex;
  gap: 20px;
  align-items: flex-start;
}

/* Â∑¶‰æßÁî®Êà∑ÂàóË°® */
.training-userlist {
  width: 200px;
  min-width: 200px;
  flex-shrink: 0;
}

/* ‰∏≠Èó¥‰∏ªË¶ÅÂÜÖÂÆπÂå∫Âüü */
.training-main {
  flex: 1;
  min-width: 0;
}

/* Âè≥‰æßËæπÊ†è */
.training-sidebar {
  width: 280px;
  min-width: 280px;
  flex-shrink: 0;
}

/* Âç°ÁâáÊ†∑Âºè */
.training-card {
  background: #fff;
  border: 1px solid #e1e4e8;
  border-radius: 6px;
  margin-bottom: 20px;
}

.training-card-header {
  padding: 16px 20px;
  border-bottom: 1px solid #e1e4e8;
  font-weight: 600;
  color: #24292e;
}

.training-card-body {
  padding: 20px;
}

/* Áî®Êà∑ÂàóË°®Ê†∑Âºè */
.training-users {
  list-style: none;
  margin: 0;
  padding: 0;
}

.training-user-item {
  border-bottom: 1px solid #f1f3f4;
}

.training-user-item:last-child {
  border-bottom: none;
}

.training-user-link {
  display: flex;
  align-items: center;
  padding: 8px 12px;
  text-decoration: none;
  color: #586069;
  transition: background-color 0.2s;
}

.training-user-link:hover {
  background-color: #f6f8fa;
  color: #24292e;
}

.training-user-link.active {
  background-color: #0366d6;
  color: white;
}

.training-user-avatar {
  width: 20px;
  height: 20px;
  border-radius: 50%;
  margin-right: 8px;
}

/* ÊêúÁ¥¢Ê°ÜÊ†∑Âºè */
.training-search {
  padding: 12px;
  border-bottom: 1px solid #e1e4e8;
}

.training-search-input {
  width: 100%;
  padding: 6px 8px;
  border: 1px solid #d0d7de;
  border-radius: 4px;
  font-size: 12px;
}

.training-search-select {
  width: 100%;
  padding: 6px 8px;
  border: 1px solid #d0d7de;
  border-radius: 4px;
  font-size: 12px;
  margin-bottom: 8px;
}

/* ‰∏ªË¶ÅÂÜÖÂÆπÊ†∑Âºè */
.training-content {
  line-height: 1.6;
  color: #24292e;
}

.training-description {
  margin-bottom: 30px;
}

/* ÈóÆÈ¢òË°®Ê†ºÊ†∑Âºè */
.training-problems {
  overflow-x: auto;
  margin: 20px 0;
}

.training-table {
  width: 100%;
  min-width: 800px;
  border-collapse: collapse;
  background: white;
  border: 1px solid #d0d7de;
  border-radius: 6px;
  overflow: hidden;
}

.training-table thead {
  background: #f6f8fa;
}

.training-table th {
  padding: 12px 16px;
  text-align: left;
  font-weight: 600;
  color: #24292e;
  border-bottom: 1px solid #d0d7de;
  white-space: nowrap;
}

.training-table td {
  padding: 10px 16px;
  border-bottom: 1px solid #f1f3f4;
  vertical-align: middle;
}

.training-table tbody tr:hover {
  background-color: #f6f8fa;
}

.training-table tbody tr:last-child td {
  border-bottom: none;
}

/* Ë°®Ê†ºÂàóÂÆΩËÆæÁΩÆ */
.training-col-status {
  width: 120px;
  text-align: center;
}

.training-col-name {
  min-width: 300px;
}

.training-col-stats {
  width: 80px;
  text-align: center;
}

.training-col-difficulty {
  width: 100px;
  text-align: center;
}

/* ÈóÆÈ¢òÈìæÊé•Ê†∑Âºè */
.training-problem-link {
  color: #0366d6;
  text-decoration: none;
  font-weight: 500;
}

.training-problem-link:hover {
  text-decoration: underline;
}

/* ‰æßËæπÊ†èËèúÂçïÊ†∑Âºè */
.training-menu {
  list-style: none;
  margin: 0;
  padding: 0;
}

.training-menu-item {
  border-bottom: 1px solid #f1f3f4;
}

.training-menu-item:last-child {
  border-bottom: none;
}

.training-menu-link {
  display: flex;
  align-items: center;
  padding: 12px 16px;
  text-decoration: none;
  color: #586069;
  transition: background-color 0.2s;
}

.training-menu-link:hover {
  background-color: #f6f8fa;
  color: #24292e;
}

.training-menu-icon {
  margin-right: 8px;
  width: 16px;
  text-align: center;
}

/* ÊåâÈíÆÊ†∑Âºè */
.training-btn {
  display: inline-flex;
  align-items: center;
  padding: 8px 16px;
  background: #0366d6;
  color: white;
  border: none;
  border-radius: 4px;
  text-decoration: none;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: background-color 0.2s;
}

.training-btn:hover {
  background: #0256c4;
  color: white;
}

.training-btn-block {
  width: 100%;
  justify-content: center;
}

/* Áä∂ÊÄÅ‰ø°ÊÅØÊ†∑Âºè */
.training-info {
  margin: 0;
  padding: 0;
}

.training-info dt {
  font-weight: 600;
  color: #24292e;
  margin-top: 12px;
  margin-bottom: 4px;
}

.training-info dt:first-child {
  margin-top: 0;
}

.training-info dd {
  margin: 0;
  color: #586069;
}

/* ÈÄöÁü•Ê∂àÊÅØÊ†∑Âºè */
.training-notice {
  padding: 16px;
  margin: 20px 0;
  background: #fff3cd;
  border: 1px solid #ffeaa7;
  border-radius: 6px;
  color: #856404;
}

.training-notice p {
  margin: 0;
}

/* ÂìçÂ∫îÂºèËÆæËÆ° */
@media (max-width: 1200px) {
  .training-layout {
    flex-direction: column;
  }
  
  .training-userlist,
  .training-sidebar {
    width: 100%;
    min-width: auto;
  }
  
  .training-userlist {
    order: 2;
  }
  
  .training-main {
    order: 1;
  }
  
  .training-sidebar {
    order: 3;
  }
}

@media (max-width: 768px) {
  .training-page {
    padding: 10px;
  }
  
  .training-layout {
    gap: 15px;
  }
  
  .training-card-body {
    padding: 15px;
  }
  
  .training-table {
    min-width: 600px;
    font-size: 14px;
  }
  
  .training-table th,
  .training-table td {
    padding: 8px 12px;
  }
}

/* ÈöêËóèFoundationÊ°ÜÊû∂ÁöÑÊ†∑ÂºèÂΩ±Âìç */
.row {
  display: block !important;
  margin: 0 !important;
  max-width: none !important;
}

.columns {
  display: block !important;
  width: auto !important;
  float: none !important;
  padding: 0 !important;
  margin: 0 !important;
}

/* ËÆ≠ÁªÉËäÇÈÄâÁä∂ÊÄÅÊ†∑Âºè */
.training-section-status {
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 14px;
  font-weight: 600;
}

.training-section-status.done {
  color: #28a745;
  background: #d4edda;
}

.training-section-status.progress {
  color: #ffc107;
  background: #fff3cd;
}

.training-section-status.open {
  color: #17a2b8;
  background: #d1ecf1;
}

.training-section-status.invalid {
  color: #dc3545;
  background: #f8d7da;
}

/* ËäÇÈÄâÂ±ïÂºÄ/ÊäòÂè†Ê†∑Âºè */
.training-section-toggle {
  color: #0366d6;
  text-decoration: none;
  font-size: 14px;
}

.training-section-toggle:hover {
  text-decoration: underline;
}

.training-card.collapsed .training-section-detail,
.training-card.collapsed .collapsed-hidden {
  display: none;
}

.training-card.expanded .expanded-hidden {
  display: none;
}

.training-section-detail {
  border-top: 1px solid #e1e4e8;
  margin-top: 0;
}
</style>

<div class="training-page">
  <div class="training-layout">
    {%- if Object.keys(udict).length -%}
    <!-- Â∑¶‰æßÁî®Êà∑ÂàóË°® -->
    <div class="training-userlist">
      <div class="training-card">
        <div class="training-search">
          <form method="get" id="searchForm">
            <select name="group" class="training-search-select"{% if not groups.length %} style="display:none"{% endif %}>
              <option value="all" selected>{{ _('All') }}</option>
              {% for group in groups %}
                <option value="{{ group.uids.join(',') }}">{{ group.name }}</option>
              {% endfor %}
            </select>
            <input name="uid" type="text" class="training-search-input" placeholder="{{ _('Select User') }}">
          </form>
        </div>
        <ul class="training-users">
          {%- for uid, udoc in udict -%}
          <li class="training-user-item">
            <a href="./{{ tdoc._id }}?uid={{ uid }}" class="training-user-link{% if (handler.request.query.uid or handler.user._id) == uid %} active{% endif %}">
              <img class="training-user-avatar" loading="lazy" src="{{ avatarUrl(udoc.avatar|default('')) }}" width="20" height="20">
              <span class="training-user-name">
                {% if handler.user.hasPerm(perm.PERM_VIEW_DISPLAYNAME) and udoc.displayName and udoc.displayName != udoc.uname %}
                  {{ udoc.displayName }} ({{ udoc.uname }})
                {% else %}
                  {{ udoc.uname }}
                {% endif %}
              </span>
            </a>
          </li>
          {%- endfor -%}
        </ul>
      </div>
    </div>
    {%- endif -%}

    <!-- ‰∏≠Èó¥‰∏ªË¶ÅÂÜÖÂÆπ -->
    <div class="training-main">
      <!-- ËÆ≠ÁªÉÊèèËø∞ -->
      <div class="training-card">
        <div class="training-card-body">
          <div class="training-content">
            {{ tdoc['content'] }}
          </div>
          <div class="training-description">
            {% if not handler.user.hasPriv(PRIV.PRIV_USER_PROFILE) %}
              <div class="training-notice">
                <p>{{ _('Login to join training plan') }}</p>
              </div>
            {% elif not tsdoc.enroll %}
              <div class="training-notice">
                <p>{{ _('page.training_detail.invalid_when_not_enrolled') }}</p>
              </div>
            {% endif %}
            {{ tdoc.description|default('')|markdown|safe }}
          </div>
        </div>
      </div>

      <!-- ÈóÆÈ¢òÂàóË°® -->
      <div class="training-card">
        <div class="training-card-header">
          {{ _('Problems') }}
        </div>
        <div class="training-problems">
          {% import "components/record.html" as record with context %}
          {% import "components/problem.html" as problem with context %}
          {% set expanded = 0 %}
          <div data-fragment-id="training_detail">
            {% if handler.request.query.uid and handler.request.query.uid != handler.user._id %}
            <div class="training-notice">
              <p>{{ _('page.training_detail.see_other_user_detail').format(udict[handler.request.query.uid].uname) }}</p>
            </div>
            {% endif %}
            {%- for node in tdoc['dag'] -%}
              <div class="training-card {% if expanded < 5 and (nsdict[node['_id']]['isProgress'] or nsdict[node['_id']]['isOpen']) %}expanded{% set expanded = expanded + 1 %}{% else %}collapsed{% endif %}">
                <div class="training-card-header">
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                      <h3 style="margin: 0; color: #24292e;">{{ _('Section') }} {{ node['_id'] }}. {{ node['title'].split('\n')[0] }}</h3>
                      {% if node['title'].split('\n')[1] %}<h5 style="margin: 5px 0 0 0; color: #586069;">{{ node['title'].split('\n')[1] }}</h5>{% endif %}
                    </div>
                    <div>
                      <span class="training-section-status {% if nsdict[node['_id']]['isDone'] %}done{% elif nsdict[node['_id']]['isProgress'] %}progress{% elif nsdict[node['_id']]['isOpen'] %}open{% else %}invalid{% endif %}">
                        {% if nsdict[node['_id']]['isDone'] %}
                          ‚úì {{ _('Completed') }}
                        {% elif nsdict[node['_id']]['isProgress'] %}
                          ‚ü≤ {{ _('In Progress') }}
                        {% elif nsdict[node['_id']]['isOpen'] %}
                          ‚óã {{ _('Open') }}
                        {% else %}
                          ‚úó {{ _('Invalid') }}
                        {% endif %}
                      </span>
                    </div>
                  </div>
                </div>
                <div class="training-card-body">
                  <div style="margin-bottom: 15px;">
                    <a href="javascript:;" class="training-section-toggle expanded-hidden" onclick="this.closest('.training-card').classList.toggle('expanded'); this.closest('.training-card').classList.toggle('collapsed');">
                      ‚ñº {{ _('expand') }}
                    </a>
                    <a href="javascript:;" class="training-section-toggle collapsed-hidden" onclick="this.closest('.training-card').classList.toggle('expanded'); this.closest('.training-card').classList.toggle('collapsed');">
                      ‚ñ≤ {{ _('collapse') }}
                    </a>
                  </div>
                </div>
                <div class="training-section-detail">
                  {% if nsdict[node['_id']]['isInvalid'] %}
                    <div class="training-card-body">
                      <div class="training-notice">
                        <p>{{ _('This section cannot be challenged at present, so please complete the following sections first') }}:</p>
                        <ul>
                          {%- for nid in node['requireNids'] -%}
                            <li>{{ _('Section') }} {{ _(nid) }}. {{ ndict[nid]['title'] }} ({{ _('Completed') }} {{ nsdict[nid]['progress'] }}%)</li>
                          {%- endfor -%}
                        </ul>
                      </div>
                    </div>
                  {% endif %}
                  {% if node['content'] %}
                    <div class="training-card-body">
                      <div class="training-content">
                        {{ node['content']|markdown|safe }}
                      </div>
                    </div>
                  {% endif %}
                  <div class="training-problems">
                    {% set should_compare = (handler.request.query.uid or handler.user._id) != handler.user._id and tsdoc["enroll"] %}
                    <table class="training-table">
                      <thead>
                        <tr>
                          {% if handler.user.hasPriv(PRIV.PRIV_USER_PROFILE) %}
                            {% if should_compare %}
                              <th class="training-col-status">{{ _('Status') }}</th>
                              <th class="training-col-status">{{ _('My status') }}</th>
                            {% else %}
                              <th class="training-col-status">{{ _('Status') }}</th>
                            {% endif %}
                          {% endif %}
                          <th class="training-col-name">{{ _('Problem') }}</th>
                          <th class="training-col-stats">{{ _('Tried') }}</th>
                          <th class="training-col-stats">{{ _('AC') }}</th>
                          <th class="training-col-difficulty">{{ _('Difficulty') }}</th>
                        </tr>
                      </thead>
                      <tbody>
                        {%- for pid in node['pids'] -%}
                          {% if pid in pdict %}
                            {% set pdoc=pdict[pid] %}
                            {% set psdoc=psdict[pid] %}
                            {% set self_psdoc=selfPsdict[pid] %}
                            <tr data-pid="{{ pid }}">
                              {% if handler.user.hasPriv(PRIV.PRIV_USER_PROFILE) %}
                                {% if psdoc['rid'] %}
                                  {{ record.render_status_td(psdoc, rid_key='rid', short=should_compare) }}
                                {% else %}
                                  <td class="training-col-status"></td>
                                {% endif %}
                                {% if should_compare %}
                                  {% if self_psdoc['rid'] %}
                                    {{ record.render_status_td(self_psdoc, rid_key='rid', short=true) }}
                                  {% else %}
                                    <td class="training-col-status"></td>
                                  {% endif %}
                                {% endif %}
                              {% endif %}
                              <td class="training-col-name"{% if handler.user.hasPriv(PRIV.PRIV_USER_PROFILE) %} data-star="{{ psdoc.star }}"{% endif %}>
                                <a href="/p/{{ pdoc.docId or pdoc._id }}" class="training-problem-link"{% if not tsdoc['enroll'] or nsdict[node['_id']]['isInvalid'] %} style="color:#999"{% endif %}>
                                  {{ pdoc.title }}
                                </a>
                              </td>
                              <td class="training-col-stats">{{ pdoc.nSubmit }}</td>
                              <td class="training-col-stats">{{ pdoc.nAccept }}</td>
                              <td class="training-col-difficulty">{{ pdoc['difficulty'] or lib.difficulty(pdoc.nSubmit, pdoc.nAccept) or _('(None)') }}</td>
                            </tr>
                          {% else %}
                            {% set pdoc = {'_id': pid, 'hidden': true, 'title': '*'} %}
                            <tr>
                              <td class="training-col-status">
                              </td>
                              <td class="training-col-name">
                                <span style="color:#999">{{ pdoc.title }}</span>
                              </td>
                              <td class="training-col-stats">*</td>
                              <td class="training-col-stats">*</td>
                              <td class="training-col-difficulty">*</td>
                            </tr>
                          {% endif %}
                        {%- endfor -%}
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            {%- endfor -%}
          </div>
        </div>
      </div>
    </div>

    <!-- Âè≥‰æßËæπÊ†è -->
    <div class="training-sidebar">
      <!-- Êìç‰ΩúËèúÂçï -->
      <div class="training-card">
        <ul class="training-menu">
          {% if not tsdoc['enroll'] and handler.user.hasPriv(PRIV.PRIV_USER_PROFILE) %}
            <li class="training-menu-item">
              <form action="" method="POST">
                <input type="hidden" name="operation" value="enroll">
                <button class="training-btn training-btn-block" type="submit">
                  <span class="training-menu-icon">+</span> {{ _('Enroll Training') }}
                </button>
              </form>
            </li>
          {% endif %}
          {% if handler.user.own(tdoc) or handler.user.hasPerm(perm.PERM_EDIT_TRAINING) %}
            <li class="training-menu-item">
              <a class="training-menu-link" href="{{ url('training_edit', tid=tdoc.docId) }}">
                <span class="training-menu-icon">‚úé</span> {{ _('Edit') }}
              </a>
            </li>
            <li class="training-menu-item">
              <a class="training-menu-link" href="{{ url('training_files', tid=tdoc.docId) }}">
                <span class="training-menu-icon">üìÅ</span> {{ _('Files') }}
              </a>
            </li>
          {% endif %}
          <li class="training-menu-item">
            <a class="training-menu-link" href="{{ url('wiki_help', anchor='training') }}">
              <span class="training-menu-icon">?</span> {{ _('Help') }}
            </a>
          </li>
        </ul>
      </div>

      <!-- ËÆ≠ÁªÉ‰ø°ÊÅØ -->
      <div class="training-card">
        <div class="training-card-header">
          {{ _('Training Info') }}
        </div>
        <div class="training-card-body">
          <dl class="training-info">
            {% if handler.user.hasPriv(PRIV.PRIV_USER_PROFILE) %}
              <dt>{{ _('Status') }}</dt>
              <dd>{% if tsdoc['enroll'] %}{{ _('Completed' if tsdoc['done'] else 'In Progress') }}{% else %}{{ _('Not Enrolled') }}{% endif %}</dd>
            {% endif %}
            {% if tsdoc['enroll'] %}
              <dt>{{ _('Progress') }}</dt>
              <dd>{{ _('Completed') }} {{ (100 * tsdoc['donePids']|length / pids|length)|round|int }}%</dd>
            {% endif %}
            <dt>{{ _('Enrollees') }}</dt>
            <dd>{{ tdoc.attend|default(0) }}</dd>
            <dt>{{ _('Created By') }}</dt>
            <dd>{{ user.render_inline(udoc, badge=false) }}</dd>
          </dl>
        </div>
      </div>

      <!-- ÂØºËà™ËèúÂçï -->
      <div class="training-card">
        <ul class="training-menu">
          {{ sidemenu.render_item('list', 'training_detail', {tid:tdoc._id}, label='tasks_list', menu_item='training_detail') }}
        </ul>
      </div>
    </div>
  </div>
</div>
{% endblock %}