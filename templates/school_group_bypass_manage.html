{% extends "layout/basic.html" %}
{% block title %}å­¦æ ¡ç»„ç»•è¿‡æƒé™ç®¡ç†{% endblock %}

{% block content %}
<style>
/* ç¾åŒ–æç¤ºæ¡†æ ·å¼ */
.alert {
  border-radius: 8px;
  padding: 12px 16px;
  margin-bottom: 16px;
  border: 1px solid;
  font-size: 14px;
}

.alert--error {
  background-color: #fef2f2;
  border-color: #fecaca;
  color: #dc2626;
}

.alert--success {
  background-color: #f0fdf4;
  border-color: #bbf7d0;
  color: #16a34a;
}

.alert--info {
  background-color: #eff6ff;
  border-color: #93c5fd;
  color: #2563eb;
}

/* ç¾åŒ–ç©ºçŠ¶æ€ */
.empty {
  text-align: center;
  padding: 48px 24px;
  background: #f9fafb;
  border-radius: 12px;
  border: 2px dashed #d1d5db;
}

.empty__icon {
  font-size: 48px;
  margin-bottom: 16px;
  opacity: 0.6;
}

.empty__text {
  color: #6b7280;
  font-size: 16px;
}

/* æŒ‰é’®æ ·å¼ */
.button {
  border-radius: 6px;
  padding: 8px 16px;
  font-weight: 500;
  text-decoration: none;
  border: none;
  cursor: pointer;
  transition: all 0.2s;
  display: inline-flex;
  align-items: center;
  gap: 6px;
}

.button--primary {
  background: #3b82f6;
  color: white;
}

.button--primary:hover {
  background: #2563eb;
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
  color: white;
  text-decoration: none;
}

.button--secondary {
  background: #6b7280;
  color: white;
}

.button--secondary:hover {
  background: #4b5563;
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(107, 114, 128, 0.4);
  color: white;
  text-decoration: none;
}

.button--danger {
  background: #ef4444;
  color: white;
}

.button--danger:hover {
  background: #dc2626;
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
  color: white;
  text-decoration: none;
}

.button--success {
  background: #10b981;
  color: white;
}

.button--success:hover {
  background: #059669;
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
  color: white;
  text-decoration: none;
}

.button--small {
  padding: 6px 12px;
  font-size: 12px;
}

/* ç¾åŒ–è¡¨æ ¼ */
.data-table {
  width: 100%;
  border-collapse: collapse;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  margin-bottom: 16px;
}

.data-table th {
  background: #f8fafc;
  font-weight: 600;
  color: #374151;
  padding: 12px 16px;
  text-align: left;
}

.data-table td {
  padding: 12px 16px;
  border-bottom: 1px solid #e5e7eb;
}

.data-table tr:hover {
  background: #f9fafb;
}

/* ç¾åŒ–åˆ†é¡µ */
.pagination {
  display: flex;
  justify-content: center;
  gap: 8px;
  margin-top: 24px;
}

.pagination__item {
  padding: 8px 12px;
  border-radius: 6px;
  text-decoration: none;
  color: #374151;
  border: 1px solid #d1d5db;
}

.pagination__item:hover {
  background: #f3f4f6;
  text-decoration: none;
}

.pagination__item--current {
  background: #3b82f6;
  color: white;
  border-color: #3b82f6;
}

/* æœç´¢å’Œç­›é€‰åŒºåŸŸ */
.filter-section {
  background: white;
  border-radius: 8px;
  padding: 20px;
  margin-bottom: 24px;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.filter-row {
  display: flex;
  gap: 16px;
  align-items: end;
  flex-wrap: wrap;
}

.filter-group {
  display: flex;
  flex-direction: column;
  gap: 4px;
  flex: 1;
  min-width: 200px;
}

.filter-group label {
  font-weight: 500;
  color: #374151;
  font-size: 14px;
}

.filter-group input,
.filter-group select {
  padding: 8px 12px;
  border: 1px solid #d1d5db;
  border-radius: 6px;
  font-size: 14px;
}

.filter-group input:focus,
.filter-group select:focus {
  outline: none;
  border-color: #3b82f6;
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

/* æ‰¹é‡æ“ä½œåŒºåŸŸ */
.batch-actions {
  background: #f8fafc;
  border-radius: 8px;
  padding: 16px;
  margin-bottom: 16px;
  border: 1px solid #e2e8f0;
  display: none;
}

.batch-actions.show {
  display: block;
}

.batch-info {
  margin-bottom: 12px;
  color: #374151;
  font-weight: 500;
}

.batch-buttons {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

/* å¤é€‰æ¡†æ ·å¼ */
.checkbox {
  width: 16px;
  height: 16px;
  cursor: pointer;
}

/* çŠ¶æ€å¾½ç«  */
.status-badge {
  padding: 4px 8px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 500;
}

.status-badge--enabled {
  background: #dcfce7;
  color: #16a34a;
}

.status-badge--disabled {
  background: #fef2f2;
  color: #dc2626;
}

/* æ·»åŠ ç”¨æˆ·è¡¨å• */
.add-user-form {
  background: white;
  border-radius: 8px;
  padding: 20px;
  margin-bottom: 24px;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  border: 2px solid #e2e8f0;
}

.form-group {
  margin-bottom: 16px;
}

.form-group label {
  display: block;
  font-weight: 500;
  color: #374151;
  margin-bottom: 4px;
}

.form-group input,
.form-group textarea {
  width: 100%;
  padding: 8px 12px;
  border: 1px solid #d1d5db;
  border-radius: 6px;
  font-size: 14px;
}

.form-group input:focus,
.form-group textarea:focus {
  outline: none;
  border-color: #3b82f6;
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.form-help {
  font-size: 12px;
  color: #6b7280;
  margin-top: 4px;
}
</style>

<div class="section">
  <div class="section__header">
    <h1 class="section__title">å­¦æ ¡ç»„ç»•è¿‡æƒé™ç®¡ç†</h1>
    <div class="section__tools">
      <button onclick="toggleAddForm()" class="button button--primary">
        <span class="icon icon-add"></span> æ·»åŠ ç»•è¿‡æƒé™
      </button>
    </div>
  </div>
  
  <div class="section__body">
    {% if error %}
    <div class="alert alert--error">{{ error }}</div>
    {% endif %}
    
    {% if success %}
    <div class="alert alert--success">{{ message }}</div>
    {% endif %}
    
    <!-- æ·»åŠ ç”¨æˆ·è¡¨å• -->
    <div id="addUserForm" class="add-user-form" style="display: none;">
      <h3 style="margin-top: 0; color: #374151;">æ·»åŠ ç»•è¿‡æƒé™ç”¨æˆ·</h3>
      <form method="post">
        <input type="hidden" name="action" value="add_bypass">
        
        <div class="form-group">
          <label for="addMethod">æ·»åŠ æ–¹å¼</label>
          <select id="addMethod" name="addMethod" onchange="toggleAddMethod()" required>
            <option value="">è¯·é€‰æ‹©æ·»åŠ æ–¹å¼</option>
            <option value="single">å•ä¸ªç”¨æˆ·ï¼ˆç”¨æˆ·åï¼‰</option>
            <option value="batch_username">æ‰¹é‡ç”¨æˆ·ï¼ˆç”¨æˆ·ååˆ—è¡¨ï¼‰</option>
            <option value="batch_uid">æ‰¹é‡ç”¨æˆ·ï¼ˆUIDåˆ—è¡¨ï¼‰</option>
          </select>
        </div>
        
        <!-- å•ä¸ªç”¨æˆ·æ·»åŠ  -->
        <div id="singleUserSection" style="display: none;">
          <div class="form-group">
            <label for="username">ç”¨æˆ·å</label>
            <input type="text" id="username" name="username" placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
            <div class="form-help">è¯·è¾“å…¥è¦æ·»åŠ ç»•è¿‡æƒé™çš„ç”¨æˆ·å</div>
          </div>
        </div>
        
        <!-- æ‰¹é‡ç”¨æˆ·åæ·»åŠ  -->
        <div id="batchUsernameSection" style="display: none;">
          <div class="form-group">
            <label for="usernames">ç”¨æˆ·ååˆ—è¡¨</label>
            <textarea id="usernames" name="usernames" rows="6" placeholder="è¯·è¾“å…¥ç”¨æˆ·ååˆ—è¡¨ï¼Œæ¯è¡Œä¸€ä¸ªç”¨æˆ·å"></textarea>
            <div class="form-help">æ¯è¡Œè¾“å…¥ä¸€ä¸ªç”¨æˆ·åï¼Œæ”¯æŒæ‰¹é‡æ·»åŠ </div>
          </div>
        </div>
        
        <!-- æ‰¹é‡UIDæ·»åŠ  -->
        <div id="batchUidSection" style="display: none;">
          <div class="form-group">
            <label for="uids">UIDåˆ—è¡¨</label>
            <textarea id="uids" name="uids" rows="6" placeholder="è¯·è¾“å…¥UIDåˆ—è¡¨ï¼Œæ¯è¡Œä¸€ä¸ªUID"></textarea>
            <div class="form-help">æ¯è¡Œè¾“å…¥ä¸€ä¸ªUIDï¼ˆæ•°å­—ï¼‰ï¼Œæ”¯æŒæ‰¹é‡æ·»åŠ </div>
          </div>
        </div>
        
        <div style="display: flex; gap: 8px; justify-content: flex-end;">
          <button type="button" onclick="toggleAddForm()" class="button button--secondary">å–æ¶ˆ</button>
          <button type="submit" class="button button--success">æ·»åŠ æƒé™</button>
        </div>
      </form>
    </div>
    
    <!-- æœç´¢ç­›é€‰åŒºåŸŸ -->
    <div class="filter-section">
      <form method="get">
        <div class="filter-row">
          <div class="filter-group">
            <label for="search">æœç´¢ç”¨æˆ·</label>
            <input type="text" id="search" name="search" value="{{ search or '' }}" placeholder="è¾“å…¥ç”¨æˆ·åæˆ–UIDæœç´¢">
          </div>
          <div class="filter-group">
            <label for="status">æƒé™çŠ¶æ€</label>
            <select id="status" name="status">
              <option value="">å…¨éƒ¨çŠ¶æ€</option>
              <option value="enabled" {% if status == 'enabled' %}selected{% endif %}>å·²å¯ç”¨</option>
              <option value="disabled" {% if status == 'disabled' %}selected{% endif %}>å·²ç¦ç”¨</option>
            </select>
          </div>
          <div class="filter-group">
            <label>&nbsp;</label>
            <button type="submit" class="button button--primary">æœç´¢</button>
          </div>
        </div>
      </form>
    </div>
    
    <!-- æ‰¹é‡æ“ä½œåŒºåŸŸ -->
    <div id="batchActions" class="batch-actions">
      <div class="batch-info">
        å·²é€‰æ‹© <span id="selectedCount">0</span> ä¸ªç”¨æˆ·
      </div>
      <div class="batch-buttons">
        <button onclick="batchOperation('enable')" class="button button--success button--small">
          <span class="icon icon-check"></span> æ‰¹é‡å¯ç”¨
        </button>
        <button onclick="batchOperation('disable')" class="button button--danger button--small">
          <span class="icon icon-close"></span> æ‰¹é‡ç¦ç”¨
        </button>
        <button onclick="batchOperation('remove')" class="button button--danger button--small">
          <span class="icon icon-delete"></span> æ‰¹é‡ç§»é™¤
        </button>
      </div>
    </div>
    
    {% if users|length > 0 %}
    <table class="data-table">
      <thead>
        <tr>
          <th style="width: 50px;">
            <input type="checkbox" id="selectAll" class="checkbox" onchange="toggleSelectAll()">
          </th>
          <th>UID</th>
          <th>ç”¨æˆ·å</th>
          <th>çœŸå®å§“å</th>
          <th>å­¦å·</th>
          <th>æƒé™çŠ¶æ€</th>
          <th>è®¾ç½®æ—¶é—´</th>
          <th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody>
        {% for user in users %}
        <tr>
          <td>
            <input type="checkbox" class="checkbox user-checkbox" value="{{ user._id }}" onchange="updateBatchActions()">
          </td>
          <td><strong>{{ user._id }}</strong></td>
          <td>{{ user.uname or 'æœªè®¾ç½®' }}</td>
          <td>{{ user.realName or 'æœªç»‘å®š' }}</td>
          <td>{{ user.studentId or 'æœªç»‘å®š' }}</td>
          <td>
            {% if user.schoolGroupBypass %}
              <span class="status-badge status-badge--enabled">å·²å¯ç”¨</span>
            {% else %}
              <span class="status-badge status-badge--disabled">å·²ç¦ç”¨</span>
            {% endif %}
          </td>
          <td>{{ user.bypassSetAt.toISOString().substring(0, 19).replace('T', ' ') if user.bypassSetAt else 'æœªçŸ¥' }}</td>
          <td>
            {% if user.schoolGroupBypass %}
              <form method="post" style="display: inline;">
                <input type="hidden" name="action" value="disable_bypass">
                <input type="hidden" name="userId" value="{{ user._id }}">
                <button type="submit" class="button button--small button--danger" 
                        onclick="return confirm('ç¡®å®šè¦ç¦ç”¨ç”¨æˆ·ã€Œ{{ user.uname or user._id }}ã€çš„ç»•è¿‡æƒé™å—ï¼Ÿ')">
                  ç¦ç”¨æƒé™
                </button>
              </form>
            {% else %}
              <form method="post" style="display: inline;">
                <input type="hidden" name="action" value="enable_bypass">
                <input type="hidden" name="userId" value="{{ user._id }}">
                <button type="submit" class="button button--small button--success" 
                        onclick="return confirm('ç¡®å®šè¦å¯ç”¨ç”¨æˆ·ã€Œ{{ user.uname or user._id }}ã€çš„ç»•è¿‡æƒé™å—ï¼Ÿ')">
                  å¯ç”¨æƒé™
                </button>
              </form>
            {% endif %}
            
            <form method="post" style="display: inline; margin-left: 8px;">
              <input type="hidden" name="action" value="remove_bypass">
              <input type="hidden" name="userId" value="{{ user._id }}">
              <button type="submit" class="button button--small button--danger" 
                      onclick="return confirm('ç¡®å®šè¦å®Œå…¨ç§»é™¤ç”¨æˆ·ã€Œ{{ user.uname or user._id }}ã€çš„ç»•è¿‡æƒé™è®°å½•å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')">
                ç§»é™¤è®°å½•
              </button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    
    {% if pageCount > 1 %}
    <div class="pagination">
      {% for i in range(1, pageCount + 1) %}
        {% if i == page %}
          <span class="pagination__item pagination__item--current">{{ i }}</span>
        {% else %}
          <a href="?page={{ i }}{% if search %}&search={{ search }}{% endif %}{% if status %}&status={{ status }}{% endif %}" class="pagination__item">{{ i }}</a>
        {% endif %}
      {% endfor %}
    </div>
    {% endif %}
    
    {% else %}
    <div class="empty">
      <div class="empty__icon">
        ğŸ”
      </div>
      <div class="empty__text">
        <p>æš‚æ— ç»•è¿‡æƒé™ç”¨æˆ·</p>
        <p><button onclick="toggleAddForm()" class="button button--primary">ç‚¹å‡»æ·»åŠ ç¬¬ä¸€ä¸ªç»•è¿‡æƒé™ç”¨æˆ·</button></p>
      </div>
    </div>
    {% endif %}
  </div>
</div>

<script>
// åˆ‡æ¢æ·»åŠ è¡¨å•æ˜¾ç¤º
function toggleAddForm() {
  const form = document.getElementById('addUserForm');
  if (form.style.display === 'none') {
    form.style.display = 'block';
    form.scrollIntoView({ behavior: 'smooth' });
  } else {
    form.style.display = 'none';
    // é‡ç½®è¡¨å•
    form.querySelector('form').reset();
    document.getElementById('addMethod').value = '';
    toggleAddMethod();
  }
}

// åˆ‡æ¢æ·»åŠ æ–¹å¼
function toggleAddMethod() {
  const method = document.getElementById('addMethod').value;
  
  // éšè—æ‰€æœ‰æ–¹å¼
  document.getElementById('singleUserSection').style.display = 'none';
  document.getElementById('batchUsernameSection').style.display = 'none';
  document.getElementById('batchUidSection').style.display = 'none';
  
  // æ˜¾ç¤ºé€‰ä¸­çš„æ–¹å¼
  if (method === 'single') {
    document.getElementById('singleUserSection').style.display = 'block';
  } else if (method === 'batch_username') {
    document.getElementById('batchUsernameSection').style.display = 'block';
  } else if (method === 'batch_uid') {
    document.getElementById('batchUidSection').style.display = 'block';
  }
}

// å…¨é€‰/å–æ¶ˆå…¨é€‰
function toggleSelectAll() {
  const selectAll = document.getElementById('selectAll');
  const checkboxes = document.querySelectorAll('.user-checkbox');
  
  checkboxes.forEach(checkbox => {
    checkbox.checked = selectAll.checked;
  });
  
  updateBatchActions();
}

// æ›´æ–°æ‰¹é‡æ“ä½œæ˜¾ç¤º
function updateBatchActions() {
  const checkboxes = document.querySelectorAll('.user-checkbox:checked');
  const batchActions = document.getElementById('batchActions');
  const selectedCount = document.getElementById('selectedCount');
  
  selectedCount.textContent = checkboxes.length;
  
  if (checkboxes.length > 0) {
    batchActions.classList.add('show');
  } else {
    batchActions.classList.remove('show');
  }
  
  // æ›´æ–°å…¨é€‰æ¡†çŠ¶æ€
  const allCheckboxes = document.querySelectorAll('.user-checkbox');
  const selectAll = document.getElementById('selectAll');
  
  if (checkboxes.length === 0) {
    selectAll.indeterminate = false;
    selectAll.checked = false;
  } else if (checkboxes.length === allCheckboxes.length) {
    selectAll.indeterminate = false;
    selectAll.checked = true;
  } else {
    selectAll.indeterminate = true;
    selectAll.checked = false;
  }
}

// æ‰¹é‡æ“ä½œ
function batchOperation(action) {
  const checkboxes = document.querySelectorAll('.user-checkbox:checked');
  
  if (checkboxes.length === 0) {
    alert('è¯·å…ˆé€‰æ‹©è¦æ“ä½œçš„ç”¨æˆ·');
    return;
  }
  
  const userIds = Array.from(checkboxes).map(cb => cb.value);
  let message = '';
  
  switch (action) {
    case 'enable':
      message = `ç¡®å®šè¦æ‰¹é‡å¯ç”¨ ${userIds.length} ä¸ªç”¨æˆ·çš„ç»•è¿‡æƒé™å—ï¼Ÿ`;
      break;
    case 'disable':
      message = `ç¡®å®šè¦æ‰¹é‡ç¦ç”¨ ${userIds.length} ä¸ªç”¨æˆ·çš„ç»•è¿‡æƒé™å—ï¼Ÿ`;
      break;
    case 'remove':
      message = `ç¡®å®šè¦æ‰¹é‡ç§»é™¤ ${userIds.length} ä¸ªç”¨æˆ·çš„ç»•è¿‡æƒé™è®°å½•å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`;
      break;
  }
  
  if (confirm(message)) {
    // åˆ›å»ºéšè—è¡¨å•æäº¤æ‰¹é‡æ“ä½œ
    const form = document.createElement('form');
    form.method = 'post';
    form.style.display = 'none';
    
    const actionInput = document.createElement('input');
    actionInput.type = 'hidden';
    actionInput.name = 'action';
    actionInput.value = 'batch_' + action;
    form.appendChild(actionInput);
    
    const userIdsInput = document.createElement('input');
    userIdsInput.type = 'hidden';
    userIdsInput.name = 'userIds';
    userIdsInput.value = userIds.join(',');
    form.appendChild(userIdsInput);
    
    document.body.appendChild(form);
    form.submit();
  }
}

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
  updateBatchActions();
});
</script>
{% endblock %}
