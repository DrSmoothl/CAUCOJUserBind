{% set page_name = 'ç»‘å®šç”³è¯·ç®¡ç†' %}
{% extends "layout/basic.html" %}

{% block content %}
<style>
/* ç®¡ç†é¡µé¢æ ·å¼ */
.bindreq-manage-container {
  max-width: 1200px;
  margin: 20px auto;
  padding: 0 20px;
}

.bindreq-manage-header {
  background: linear-gradient(135deg, #6366f1, #4f46e5);
  color: white;
  padding: 32px 40px;
  border-radius: 16px;
  margin-bottom: 24px;
  position: relative;
  overflow: hidden;
}

.bindreq-manage-header::before {
  content: '';
  position: absolute;
  top: -50%;
  right: -50%;
  width: 200%;
  height: 200%;
  background: radial-gradient(
    circle,
    rgba(255,255,255,0.1) 0%,
    transparent 50%
  );
  animation: bindreq-manage-float 15s ease-in-out infinite;
}

@keyframes bindreq-manage-float {
  0%, 100% { transform: translateY(0) rotate(0deg); }
  50% { transform: translateY(-30px) rotate(180deg); }
}

.bindreq-manage-header-content {
  position: relative;
  z-index: 1;
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 16px;
}

.bindreq-manage-title-group h1 {
  font-size: 2.5rem;
  font-weight: 700;
  margin: 0 0 8px 0;
  display: flex;
  align-items: center;
  gap: 12px;
}

.bindreq-manage-title-group p {
  font-size: 1.1rem;
  opacity: 0.9;
  margin: 0;
}

.bindreq-manage-actions {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
}

.bindreq-manage-btn {
  padding: 12px 24px;
  border-radius: 10px;
  font-size: 15px;
  font-weight: 600;
  text-decoration: none;
  border: 2px solid;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  gap: 8px;
  white-space: nowrap;
}

.bindreq-manage-btn--white {
  background: white;
  color: #6366f1;
  border-color: white;
}

.bindreq-manage-btn--white:hover {
  background: #f8fafc;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  text-decoration: none;
  color: #4f46e5;
}

/* é€šçŸ¥æ¶ˆæ¯ */
.bindreq-manage-notice {
  border-radius: 12px;
  padding: 16px 20px;
  margin-bottom: 20px;
  border: 2px solid;
  display: flex;
  align-items: flex-start;
  gap: 12px;
  font-size: 15px;
}

.bindreq-manage-notice--success {
  background: linear-gradient(135deg, #f0fdf4, #dcfce7);
  border-color: #22c55e;
  color: #15803d;
}

.bindreq-manage-notice--error {
  background: linear-gradient(135deg, #fef2f2, #fee2e2);
  border-color: #f87171;
  color: #dc2626;
}

/* ç­›é€‰åŒºåŸŸ */
.bindreq-manage-filters {
  background: white;
  border: 2px solid #e5e7eb;
  border-radius: 16px;
  padding: 24px;
  margin-bottom: 24px;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
}

.bindreq-manage-filters-title {
  font-size: 18px;
  font-weight: 600;
  color: #374151;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.bindreq-manage-filter-form {
  display: flex;
  align-items: center;
  gap: 16px;
  flex-wrap: wrap;
}

.bindreq-manage-filter-select {
  padding: 10px 16px;
  border: 2px solid #e5e7eb;
  border-radius: 8px;
  font-size: 15px;
  background: white;
  cursor: pointer;
  transition: all 0.3s ease;
}

.bindreq-manage-filter-select:focus {
  outline: none;
  border-color: #6366f1;
  box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
}

/* æ•°æ®è¡¨æ ¼ */
.bindreq-manage-table-container {
  background: white;
  border: 2px solid #e5e7eb;
  border-radius: 16px;
  overflow: hidden;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
  margin-bottom: 24px;
}

.bindreq-manage-table {
  width: 100%;
  border-collapse: collapse;
}

.bindreq-manage-table thead {
  background: linear-gradient(135deg, #f8fafc, #f1f5f9);
}

.bindreq-manage-table th {
  padding: 16px 12px;
  text-align: left;
  font-weight: 600;
  color: #374151;
  border-bottom: 2px solid #e5e7eb;
  font-size: 14px;
}

.bindreq-manage-table td {
  padding: 16px 12px;
  border-bottom: 1px solid #f3f4f6;
  vertical-align: middle;
  font-size: 14px;
}

.bindreq-manage-table tbody tr:hover {
  background: #f9fafb;
}

.bindreq-manage-table tbody tr:last-child td {
  border-bottom: none;
}

/* çŠ¶æ€å¾½ç«  */
.bindreq-status-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 13px;
  font-weight: 600;
  white-space: nowrap;
}

.bindreq-status-badge--pending {
  background: linear-gradient(135deg, #fef3c7, #fde68a);
  color: #92400e;
  border: 1px solid #f59e0b;
}

.bindreq-status-badge--approved {
  background: linear-gradient(135deg, #dcfce7, #bbf7d0);
  color: #166534;
  border: 1px solid #22c55e;
}

.bindreq-status-badge--rejected {
  background: linear-gradient(135deg, #fee2e2, #fecaca);
  color: #991b1b;
  border: 1px solid #f87171;
}

/* ç”¨æˆ·é“¾æ¥ */
.bindreq-user-link {
  color: #6366f1;
  text-decoration: none;
  font-weight: 600;
  padding: 4px 8px;
  border-radius: 6px;
  transition: all 0.3s ease;
}

.bindreq-user-link:hover {
  background: #f0f4ff;
  color: #4f46e5;
  text-decoration: none;
}

/* æ“ä½œæŒ‰é’®ç»„ */
.bindreq-action-group {
  display: flex;
  gap: 8px;
  align-items: center;
  flex-wrap: wrap;
}

.bindreq-action-btn {
  padding: 8px 16px;
  border-radius: 8px;
  font-size: 13px;
  font-weight: 600;
  text-decoration: none;
  border: 2px solid;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  gap: 6px;
  white-space: nowrap;
}

.bindreq-action-btn--approve {
  background: linear-gradient(135deg, #10b981, #059669);
  color: white;
  border-color: #10b981;
}

.bindreq-action-btn--approve:hover {
  background: linear-gradient(135deg, #059669, #047857);
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(16, 185, 129, 0.3);
}

.bindreq-action-btn--reject {
  background: linear-gradient(135deg, #ef4444, #dc2626);
  color: white;
  border-color: #ef4444;
}

.bindreq-action-btn--reject:hover {
  background: linear-gradient(135deg, #dc2626, #b91c1c);
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(239, 68, 68, 0.3);
}

/* å®¡æ ¸ä¿¡æ¯ */
.bindreq-review-info {
  font-size: 12px;
  color: #6b7280;
  line-height: 1.4;
}

.bindreq-review-info strong {
  color: #374151;
}

/* åˆ†é¡µå™¨ */
.bindreq-paginator {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 16px;
  padding: 24px;
  background: white;
  border: 2px solid #e5e7eb;
  border-radius: 16px;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
}

.bindreq-paginator-btn {
  padding: 10px 20px;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  text-decoration: none;
  border: 2px solid #e5e7eb;
  background: white;
  color: #374151;
  cursor: pointer;
  transition: all 0.3s ease;
}

.bindreq-paginator-btn:hover {
  border-color: #6366f1;
  color: #6366f1;
  text-decoration: none;
  transform: translateY(-1px);
}

.bindreq-paginator-info {
  font-size: 14px;
  color: #6b7280;
  font-weight: 500;
}

/* ç©ºçŠ¶æ€ */
.bindreq-empty-state {
  text-align: center;
  padding: 60px 40px;
  background: white;
  border: 2px solid #e5e7eb;
  border-radius: 16px;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
}

.bindreq-empty-icon {
  font-size: 4rem;
  margin-bottom: 16px;
  opacity: 0.5;
}

.bindreq-empty-title {
  font-size: 1.5rem;
  font-weight: 600;
  color: #374151;
  margin-bottom: 8px;
}

.bindreq-empty-desc {
  color: #6b7280;
  font-size: 15px;
}

/* sectioné‡ç½® */
.section {
  background: transparent;
  box-shadow: none;
}

.section__header {
  display: none;
}

.section__body {
  padding: 0;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 1024px) {
  .bindreq-manage-table {
    font-size: 13px;
  }
  
  .bindreq-manage-table th,
  .bindreq-manage-table td {
    padding: 12px 8px;
  }
}

@media (max-width: 768px) {
  .bindreq-manage-container {
    padding: 0 16px;
  }
  
  .bindreq-manage-header {
    padding: 24px 20px;
  }
  
  .bindreq-manage-header-content {
    flex-direction: column;
    text-align: center;
  }
  
  .bindreq-manage-title-group h1 {
    font-size: 2rem;
  }
  
  .bindreq-manage-filters {
    padding: 20px 16px;
  }
  
  .bindreq-manage-filter-form {
    flex-direction: column;
    align-items: stretch;
  }
  
  .bindreq-manage-filter-select {
    width: 100%;
  }
  
  /* ç§»åŠ¨ç«¯è¡¨æ ¼ä¼˜åŒ– */
  .bindreq-manage-table-container {
    overflow-x: auto;
  }
  
  .bindreq-manage-table {
    min-width: 800px;
  }
  
  .bindreq-paginator {
    flex-direction: column;
    gap: 12px;
  }
}

/* å¼¹çª—æ ·å¼ */
.bindreq-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 9999;
  display: flex;
  align-items: center;
  justify-content: center;
}

.bindreq-modal-overlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(4px);
}

.bindreq-modal-content {
  position: relative;
  background: white;
  border-radius: 16px;
  box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
  width: 90%;
  max-width: 500px;
  max-height: 90vh;
  overflow: hidden;
  animation: bindreq-modal-appear 0.3s ease-out;
}

@keyframes bindreq-modal-appear {
  from {
    opacity: 0;
    transform: scale(0.9) translateY(-20px);
  }
  to {
    opacity: 1;
    transform: scale(1) translateY(0);
  }
}

.bindreq-modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 24px 24px 16px 24px;
  border-bottom: 2px solid #f3f4f6;
}

.bindreq-modal-header h3 {
  margin: 0;
  font-size: 1.25rem;
  font-weight: 600;
  color: #374151;
}

.bindreq-modal-close {
  background: none;
  border: none;
  font-size: 24px;
  color: #6b7280;
  cursor: pointer;
  padding: 4px;
  border-radius: 6px;
  transition: all 0.3s ease;
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.bindreq-modal-close:hover {
  background: #f3f4f6;
  color: #374151;
}

.bindreq-modal-body {
  padding: 16px 24px 24px 24px;
}

.bindreq-modal-body p {
  margin: 0 0 20px 0;
  color: #374151;
  font-size: 15px;
  line-height: 1.5;
}

.bindreq-modal-form-group {
  margin-bottom: 16px;
}

.bindreq-modal-form-group label {
  display: block;
  margin-bottom: 8px;
  font-weight: 600;
  color: #374151;
  font-size: 14px;
}

.bindreq-modal-textarea {
  width: 100%;
  padding: 12px 16px;
  border: 2px solid #e5e7eb;
  border-radius: 8px;
  font-size: 14px;
  font-family: inherit;
  resize: vertical;
  min-height: 80px;
  transition: all 0.3s ease;
}

.bindreq-modal-textarea:focus {
  outline: none;
  border-color: #ef4444;
  box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
}

.bindreq-modal-footer {
  display: flex;
  justify-content: flex-end;
  gap: 12px;
  padding: 16px 24px 24px 24px;
  border-top: 2px solid #f3f4f6;
}

.bindreq-modal-btn {
  padding: 10px 20px;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  border: 2px solid;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  gap: 6px;
}

.bindreq-modal-btn--cancel {
  background: white;
  color: #6b7280;
  border-color: #d1d5db;
}

.bindreq-modal-btn--cancel:hover {
  background: #f9fafb;
  color: #374151;
  border-color: #9ca3af;
}

.bindreq-modal-btn--danger {
  background: linear-gradient(135deg, #ef4444, #dc2626);
  color: white;
  border-color: #ef4444;
}

.bindreq-modal-btn--danger:hover {
  background: linear-gradient(135deg, #dc2626, #b91c1c);
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(239, 68, 68, 0.3);
}
</style>

<div class="section">
    <div class="section__body">
        <div class="bindreq-manage-container">
            <div class="bindreq-manage-header">
                <div class="bindreq-manage-header-content">
                    <div class="bindreq-manage-title-group">
                        <h1><span>âš–ï¸</span> ç»‘å®šç”³è¯·ç®¡ç†</h1>
                        <p>å®¡æ ¸å’Œç®¡ç†ç”¨æˆ·çš„ç»‘å®šç”³è¯·</p>
                    </div>
                    <div class="bindreq-manage-actions">
                        <a href="/management" class="bindreq-manage-btn bindreq-manage-btn--white">
                            <span>ğŸ”™</span> è¿”å›ç®¡ç†é¡µ
                        </a>
                    </div>
                </div>
            </div>
            
            {% if success %}
            <div class="bindreq-manage-notice bindreq-manage-notice--success">
                <span>âœ…</span>
                {{ message }}
            </div>
            {% endif %}
            
            {% if error %}
            <div class="bindreq-manage-notice bindreq-manage-notice--error">
                <span>âŒ</span>
                {{ error }}
            </div>
            {% endif %}

            <!-- ç­›é€‰åŒºåŸŸ -->
            <div class="bindreq-manage-filters">
                <div class="bindreq-manage-filters-title">
                    <span>ğŸ”</span> ç­›é€‰æ¡ä»¶
                </div>
                <form method="get" class="bindreq-manage-filter-form">
                    <select name="status" class="bindreq-manage-filter-select" onchange="this.form.submit()">
                        <option value="">å…¨éƒ¨çŠ¶æ€</option>
                        <option value="pending" {% if status == 'pending' %}selected{% endif %}>â³ å¾…å®¡æ ¸</option>
                        <option value="approved" {% if status == 'approved' %}selected{% endif %}>âœ… å·²åŒæ„</option>
                        <option value="rejected" {% if status == 'rejected' %}selected{% endif %}>âŒ å·²æ‹’ç»</option>
                    </select>
                    <input type="hidden" name="page" value="1">
                </form>
            </div>

            {% if requests %}
            <div class="bindreq-manage-table-container">
                <table class="bindreq-manage-table">
                    <thead>
                        <tr>
                            <th>ğŸ‘¤ ç”¨æˆ·</th>
                            <th>ğŸ« å­¦æ ¡ç»„</th>
                            <th>ğŸ†” å­¦å·</th>
                            <th>ğŸ“ å§“å</th>
                            <th>ğŸ“… ç”³è¯·æ—¶é—´</th>
                            <th>ğŸ“Š çŠ¶æ€</th>
                            <th>âš¡ æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for request in requests %}
                        <tr>
                            <td>
                                {% if request.user %}
                                <a href="/user/{{ request.user._id }}" class="bindreq-user-link">{{ request.user.uname }}</a>
                                {% else %}
                                <span style="color: #ef4444;">ç”¨æˆ·ä¸å­˜åœ¨</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if request.school %}
                                <span style="color: #374151; font-weight: 500;">{{ request.school.name }}</span>
                                {% else %}
                                <span style="color: #ef4444;">å­¦æ ¡ç»„ä¸å­˜åœ¨</span>
                                {% endif %}
                            </td>
                            <td><strong>{{ request.studentId }}</strong></td>
                            <td><strong>{{ request.realName }}</strong></td>
                            <td style="color: #6b7280;">{{ request.createdAtFormatted or 'æœªçŸ¥æ—¶é—´' }}</td>
                            <td>
                                {% if request.status == 'pending' %}
                                <span class="bindreq-status-badge bindreq-status-badge--pending">
                                    â³ å¾…å®¡æ ¸
                                </span>
                                {% elif request.status == 'approved' %}
                                <span class="bindreq-status-badge bindreq-status-badge--approved">
                                    âœ… å·²åŒæ„
                                </span>
                                {% elif request.status == 'rejected' %}
                                <span class="bindreq-status-badge bindreq-status-badge--rejected">
                                    âŒ å·²æ‹’ç»
                                </span>
                                {% endif %}
                            </td>
                            <td>
                                {% if request.status == 'pending' %}
                                <div class="bindreq-action-group">
                                    <form method="post" style="display: inline;" id="approve-form-{{ request._id }}">
                                        <input type="hidden" name="requestId" value="{{ request._id }}">
                                        <input type="hidden" name="action" value="approve">
                                        <button type="button" class="bindreq-action-btn bindreq-action-btn--approve" 
                                                data-request-id="{{ request._id }}" 
                                                data-user-name="{{ request.user.uname if request.user else 'æœªçŸ¥ç”¨æˆ·' }}"
                                                onclick="showApproveConfirmModal(this)">
                                            <span>âœ“</span> åŒæ„
                                        </button>
                                    </form>
                                    <button type="button" class="bindreq-action-btn bindreq-action-btn--reject" 
                                            onclick="showRejectModal('{{ request._id }}', '{{ request.user.uname }}')">
                                        <span>âœ—</span> æ‹’ç»
                                    </button>
                                </div>
                                {% else %}
                                <div class="bindreq-review-info">
                                    {% if request.reviewer %}
                                    <div><strong>å®¡æ ¸è€…ï¼š</strong>{{ request.reviewer.uname }}</div>
                                    {% endif %}
                                    {% if request.reviewedAt %}
                                    <div><strong>å®¡æ ¸æ—¶é—´ï¼š</strong>{{ request.reviewedAtFormatted or 'æœªçŸ¥æ—¶é—´' }}</div>
                                    {% endif %}
                                    {% if request.reviewComment %}
                                    <div><strong>å¤‡æ³¨ï¼š</strong>{{ request.reviewComment }}</div>
                                    {% endif %}
                                </div>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- åˆ†é¡µå™¨ -->
            {% if pageCount > 1 %}
            <div class="bindreq-paginator">
                {% if page > 1 %}
                <a href="?page={{ page - 1 }}{% if status %}&status={{ status }}{% endif %}" 
                   class="bindreq-paginator-btn">
                    â† ä¸Šä¸€é¡µ
                </a>
                {% endif %}
                
                <div class="bindreq-paginator-info">
                    ç¬¬ {{ page }} é¡µï¼Œå…± {{ pageCount }} é¡µï¼Œæ€»è®¡ {{ total }} ä¸ªç”³è¯·
                </div>
                
                {% if page < pageCount %}
                <a href="?page={{ page + 1 }}{% if status %}&status={{ status }}{% endif %}" 
                   class="bindreq-paginator-btn">
                    ä¸‹ä¸€é¡µ â†’
                </a>
                {% endif %}
            </div>
            {% endif %}
            {% else %}
            <div class="bindreq-empty-state">
                <div class="bindreq-empty-icon">ğŸ“‹</div>
                <div class="bindreq-empty-title">æš‚æ— ç»‘å®šç”³è¯·</div>
                <div class="bindreq-empty-desc">å½“å‰æ²¡æœ‰éœ€è¦å®¡æ ¸çš„ç»‘å®šç”³è¯·</div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- æ‹’ç»ç”³è¯·å¼¹çª— -->
<div id="rejectModal" class="bindreq-modal" style="display: none;">
    <div class="bindreq-modal-overlay" onclick="hideRejectModal()"></div>
    <div class="bindreq-modal-content">
        <div class="bindreq-modal-header">
            <h3>æ‹’ç»ç»‘å®šç”³è¯·</h3>
            <button type="button" class="bindreq-modal-close" onclick="hideRejectModal()">Ã—</button>
        </div>
        <div class="bindreq-modal-body">
            <p>æ‚¨ç¡®å®šè¦æ‹’ç»ç”¨æˆ· <strong id="rejectUserName"></strong> çš„ç»‘å®šç”³è¯·å—ï¼Ÿ</p>
            <form id="rejectForm" method="post">
                <input type="hidden" name="requestId" id="rejectRequestId">
                <input type="hidden" name="action" value="reject">
                <div class="bindreq-modal-form-group">
                    <label for="rejectReason">æ‹’ç»ç†ç”±ï¼š</label>
                    <textarea name="reviewComment" id="rejectReason" 
                              class="bindreq-modal-textarea" 
                              placeholder="è¯·è¾“å…¥æ‹’ç»ç†ç”±ï¼ˆé€‰å¡«ï¼‰"
                              rows="4"></textarea>
                </div>
            </form>
        </div>
        <div class="bindreq-modal-footer">
            <button type="button" class="bindreq-modal-btn bindreq-modal-btn--cancel" onclick="hideRejectModal()">
                å–æ¶ˆ
            </button>
            <button type="button" class="bindreq-modal-btn bindreq-modal-btn--danger" onclick="confirmReject()">
                ç¡®è®¤æ‹’ç»
            </button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // è‡ªåŠ¨åˆ·æ–°åŠŸèƒ½
    let refreshInterval;
    
    function startAutoRefresh() {
        refreshInterval = setInterval(() => {
            // åªæœ‰åœ¨é¡µé¢å¯è§æ—¶æ‰è‡ªåŠ¨åˆ·æ–°
            if (!document.hidden && window.location.search.includes('status=pending')) {
                const url = new URL(window.location);
                url.searchParams.set('_refresh', Date.now());
                fetch(url.toString())
                    .then(response => response.text())
                    .then(html => {
                        // è¿™é‡Œå¯ä»¥æ›´æ™ºèƒ½åœ°æ›´æ–°é¡µé¢å†…å®¹
                        // æ¯”å¦‚åªæ›´æ–°è¡¨æ ¼éƒ¨åˆ†
                    })
                    .catch(err => console.log('è‡ªåŠ¨åˆ·æ–°å¤±è´¥:', err));
            }
        }, 30000); // 30ç§’åˆ·æ–°ä¸€æ¬¡
    }
    
    // å½“æ˜¾ç¤ºå¾…å®¡æ ¸çŠ¶æ€æ—¶å¼€å§‹è‡ªåŠ¨åˆ·æ–°
    if (window.location.search.includes('status=pending')) {
        startAutoRefresh();
    }
    
    // é¡µé¢å¯è§æ€§å˜åŒ–æ—¶æ§åˆ¶è‡ªåŠ¨åˆ·æ–°
    document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
            clearInterval(refreshInterval);
        } else if (window.location.search.includes('status=pending')) {
            startAutoRefresh();
        }
    });
    
    // æ·»åŠ è¡¨æ ¼è¡Œçš„æ‚¬åœæ•ˆæœ
    const tableRows = document.querySelectorAll('.bindreq-manage-table tbody tr');
    tableRows.forEach(row => {
        row.addEventListener('mouseenter', function() {
            this.style.transform = 'translateX(2px)';
            this.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.1)';
        });
        
        row.addEventListener('mouseleave', function() {
            this.style.transform = 'translateX(0)';
            this.style.boxShadow = 'none';
        });
    });
    
    // æ‰¹é‡æ“ä½œåŠŸèƒ½ï¼ˆå¯æ‰©å±•ï¼‰
    const approveButtons = document.querySelectorAll('.bindreq-action-btn--approve');
    
    approveButtons.forEach(btn => {
        btn.addEventListener('click', function(e) {
            const icon = this.querySelector('span');
            icon.style.animation = 'none';
            icon.offsetHeight;
            icon.style.animation = 'bindreq-pending-pulse 0.5s ease-in-out';
        });
    });
    
    // é”®ç›˜å¿«æ·é”®æ”¯æŒ
    document.addEventListener('keydown', function(e) {
        // Ctrl+R æˆ– F5 åˆ·æ–°é¡µé¢
        if ((e.ctrlKey && e.key === 'r') || e.key === 'F5') {
            e.preventDefault();
            window.location.reload();
        }
        
        // æ•°å­—é”®å¿«é€Ÿç­›é€‰
        if (e.key >= '1' && e.key <= '3' && !e.ctrlKey && !e.altKey) {
            const select = document.querySelector('.bindreq-manage-filter-select');
            if (select && document.activeElement !== select) {
                const options = select.options;
                if (options[parseInt(e.key)]) {
                    select.selectedIndex = parseInt(e.key);
                    select.form.submit();
                }
            }
        }
    });
});

// å¼¹çª—ç›¸å…³å‡½æ•°
function showCaucojModal(type, title, message) {
    // åˆ›å»ºä¸´æ—¶æ¨¡æ€æ¡†ï¼Œå› ä¸ºé¡µé¢å·²æœ‰è‡ªå®šä¹‰å¼¹çª—
    const existingModal = document.getElementById('caucojTempModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    const modal = document.createElement('div');
    modal.id = 'caucojTempModal';
    modal.className = 'bindreq-modal';
    modal.style.display = 'flex';
    
    let iconColor = '#3b82f6';
    let iconBg = '#dbeafe';
    let icon = 'â„¹ï¸';
    
    if (type === 'error') {
        iconColor = '#ef4444';
        iconBg = '#fee2e2';
        icon = 'âŒ';
    } else if (type === 'success') {
        iconColor = '#10b981';
        iconBg = '#dcfce7';
        icon = 'âœ…';
    } else if (type === 'warning') {
        iconColor = '#f59e0b';
        iconBg = '#fef3c7';
        icon = 'âš ï¸';
    }
    
    modal.innerHTML = `
        <div class="bindreq-modal-overlay" onclick="hideCaucojModal()"></div>
        <div class="bindreq-modal-content">
            <div class="bindreq-modal-header">
                <h3 style="display: flex; align-items: center; gap: 12px;">
                    <span style="font-size: 24px; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 50%; background: ${iconBg};">${icon}</span>
                    ${title}
                </h3>
                <button type="button" class="bindreq-modal-close" onclick="hideCaucojModal()">Ã—</button>
            </div>
            <div class="bindreq-modal-body">
                <p style="white-space: pre-line;">${message}</p>
            </div>
            <div class="bindreq-modal-footer">
                <button type="button" class="bindreq-modal-btn bindreq-modal-btn--cancel" onclick="hideCaucojModal()">ç¡®å®š</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    document.body.style.overflow = 'hidden';
}

function hideCaucojModal() {
    const modal = document.getElementById('caucojTempModal');
    if (modal) {
        modal.remove();
        document.body.style.overflow = '';
    }
}

function showCaucojConfirmModal(title, message, callback) {
    const existingModal = document.getElementById('caucojConfirmTempModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    const modal = document.createElement('div');
    modal.id = 'caucojConfirmTempModal';
    modal.className = 'bindreq-modal';
    modal.style.display = 'flex';
    
    modal.innerHTML = `
        <div class="bindreq-modal-overlay" onclick="hideCaucojConfirmModal()"></div>
        <div class="bindreq-modal-content">
            <div class="bindreq-modal-header">
                <h3 style="display: flex; align-items: center; gap: 12px;">
                    <span style="font-size: 24px; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 50%; background: #fef3c7;">âš ï¸</span>
                    ${title}
                </h3>
                <button type="button" class="bindreq-modal-close" onclick="hideCaucojConfirmModal()">Ã—</button>
            </div>
            <div class="bindreq-modal-body">
                <p style="white-space: pre-line;">${message}</p>
            </div>
            <div class="bindreq-modal-footer">
                <button type="button" class="bindreq-modal-btn bindreq-modal-btn--cancel" onclick="hideCaucojConfirmModal()">å–æ¶ˆ</button>
                <button type="button" class="bindreq-modal-btn bindreq-modal-btn--danger" onclick="confirmCaucojModal()">ç¡®å®š</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    document.body.style.overflow = 'hidden';
    
    // è®¾ç½®å›è°ƒ
    window.caucojConfirmCallback = callback;
}

function hideCaucojConfirmModal() {
    const modal = document.getElementById('caucojConfirmTempModal');
    if (modal) {
        modal.remove();
        document.body.style.overflow = '';
    }
    window.caucojConfirmCallback = null;
}

function confirmCaucojModal() {
    if (window.caucojConfirmCallback) {
        window.caucojConfirmCallback(true);
    }
    hideCaucojConfirmModal();
}

function showApproveConfirmModal(button) {
    const requestId = button.getAttribute('data-request-id');
    const userName = button.getAttribute('data-user-name');
    
    showCaucojConfirmModal(
        'ç¡®è®¤åŒæ„', 
        `ç¡®å®šè¦åŒæ„ç”¨æˆ·ã€Œ${userName}ã€çš„ç»‘å®šç”³è¯·å—ï¼Ÿ`, 
        function(confirmed) {
            if (confirmed) {
                const form = document.getElementById('approve-form-' + requestId);
                form.submit();
            }
        }
    );
}

function showRejectModal(requestId, userName) {
    document.getElementById('rejectRequestId').value = requestId;
    document.getElementById('rejectUserName').textContent = userName;
    document.getElementById('rejectReason').value = '';
    document.getElementById('rejectModal').style.display = 'flex';
    
    // èšç„¦åˆ°æ–‡æœ¬æ¡†
    setTimeout(() => {
        document.getElementById('rejectReason').focus();
    }, 100);
    
    // é˜²æ­¢é¡µé¢æ»šåŠ¨
    document.body.style.overflow = 'hidden';
}

function hideRejectModal() {
    document.getElementById('rejectModal').style.display = 'none';
    document.body.style.overflow = '';
}

function confirmReject() {
    const reason = document.getElementById('rejectReason').value.trim();
    
    // å¯ä»¥é€‰æ‹©æ˜¯å¦å¿…é¡»å¡«å†™æ‹’ç»ç†ç”±
    if (!reason) {
        showCaucojConfirmModal('ç¡®è®¤æ‹’ç»', 'æ‚¨æ²¡æœ‰å¡«å†™æ‹’ç»ç†ç”±ï¼Œç¡®å®šè¦ç»§ç»­æ‹’ç»å—ï¼Ÿ', function(confirmed) {
            if (confirmed) {
                document.getElementById('rejectForm').submit();
            }
        });
    } else {
        // æœ‰ç†ç”±çš„è¯ç›´æ¥æäº¤
        document.getElementById('rejectForm').submit();
    }
}

// é”®ç›˜äº‹ä»¶å¤„ç†
document.addEventListener('keydown', function(e) {
    const modal = document.getElementById('rejectModal');
    const caucojModal = document.getElementById('caucojTempModal');
    const caucojConfirmModal = document.getElementById('caucojConfirmTempModal');
    
    if (modal && modal.style.display === 'flex') {
        if (e.key === 'Escape') {
            hideRejectModal();
        } else if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
            confirmReject();
        }
    } else if (caucojModal) {
        if (e.key === 'Escape') {
            hideCaucojModal();
        }
    } else if (caucojConfirmModal) {
        if (e.key === 'Escape') {
            hideCaucojConfirmModal();
        } else if (e.key === 'Enter') {
            confirmCaucojModal();
        }
    }
});
</script>
{% endblock %}
